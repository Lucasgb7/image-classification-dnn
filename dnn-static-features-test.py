"""
Raspberry Pi DNN Static Image Feature Test

Copy trained .eim model from Edge Impulse project to folder with this program. 
Copy feature set from test sample from project to features variable.

Author: EdgeImpulse, Inc.
Date: June 8, 2021
License: Apache-2.0 (apache.org/licenses/LICENSE-2.0)
"""

import os, time
from edge_impulse_linux.runner import ImpulseRunner

# Settings
model_file = "modelfile.eim"

# Copy in features from test sample in Edge Impulse
features = [0.7594, 0.7606, 0.7671, 0.7730, 0.7756, 0.7856, 0.7943, 0.7867, 0.7712, 0.7684, 0.7687, 0.7570, 0.7449, 0.7430, 0.7383, 0.7382, 0.7378, 0.7364, 0.7358, 0.7383, 0.7402, 0.7397, 0.7360, 0.7345, 0.7333, 0.7326, 0.7312, 0.7292, 0.7648, 0.7648, 0.7685, 0.7752, 0.7818, 0.7884, 0.7935, 0.7814, 0.7734, 0.7748, 0.7701, 0.7564, 0.7490, 0.7463, 0.7433, 0.7431, 0.7434, 0.7391, 0.7382, 0.7416, 0.7419, 0.7383, 0.7390, 0.7391, 0.7396, 0.7392, 0.7369, 0.7343, 0.7680, 0.7671, 0.7707, 0.7763, 0.7797, 0.7832, 0.7874, 0.7787, 0.7330, 0.6804, 0.6537, 0.6455, 0.6564, 0.6757, 0.6886, 0.7032, 0.7188, 0.7275, 0.7365, 0.7386, 0.7388, 0.7419, 0.7434, 0.7435, 0.7440, 0.7397, 0.7378, 0.7379, 0.7641, 0.7665, 0.7697, 0.7706, 0.7712, 0.7732, 0.7826, 0.7067, 0.4310, 0.4272, 0.3642, 0.3379, 0.3348, 0.3327, 0.3360, 0.3513, 0.3751, 0.4130, 0.4960, 0.6841, 0.7352, 0.7406, 0.7431, 0.7397, 0.7420, 0.7402, 0.7372, 0.7374, 0.7629, 0.7656, 0.7657, 0.7653, 0.7647, 0.7621, 0.7493, 0.6323, 0.3470, 0.3907, 0.3322, 0.3046, 0.2904, 0.2773, 0.2689, 0.2600, 0.2628, 0.2650, 0.2685, 0.5206, 0.7321, 0.7399, 0.7394, 0.7413, 0.7416, 0.7396, 0.7359, 0.7334, 0.7599, 0.7618, 0.7617, 0.7602, 0.7619, 0.7584, 0.7489, 0.6244, 0.3871, 0.4313, 0.3872, 0.3224, 0.2872, 0.2677, 0.2608, 0.2488, 0.2604, 0.2735, 0.2557, 0.4711, 0.7152, 0.7264, 0.7311, 0.7341, 0.7348, 0.7337, 0.7327, 0.7304, 0.7558, 0.7573, 0.7554, 0.7570, 0.7554, 0.7511, 0.7290, 0.6114, 0.5632, 0.6649, 0.6297, 0.4925, 0.3788, 0.2567, 0.2676, 0.2695, 0.2531, 0.2726, 0.2546, 0.4134, 0.6414, 0.6668, 0.6823, 0.6895, 0.6994, 0.7144, 0.7220, 0.7256, 0.7499, 0.7507, 0.7521, 0.7517, 0.7467, 0.7437, 0.6844, 0.6078, 0.6152, 0.6846, 0.6114, 0.5072, 0.4156, 0.3025, 0.2725, 0.2454, 0.2524, 0.2725, 0.2510, 0.3722, 0.6087, 0.6465, 0.6585, 0.6613, 0.6698, 0.6891, 0.7013, 0.7117, 0.7478, 0.7466, 0.7449, 0.7443, 0.7444, 0.7432, 0.6695, 0.6241, 0.6425, 0.7213, 0.6087, 0.4798, 0.3549, 0.2636, 0.2615, 0.2546, 0.2713, 0.2606, 0.2408, 0.3358, 0.5815, 0.6385, 0.6529, 0.6594, 0.6657, 0.6792, 0.6902, 0.7009, 0.7451, 0.7419, 0.7419, 0.7451, 0.7476, 0.7522, 0.6784, 0.6410, 0.6550, 0.6578, 0.5342, 0.4912, 0.3884, 0.2632, 0.2612, 0.2539, 0.2478, 0.2516, 0.2452, 0.3190, 0.5678, 0.6345, 0.6494, 0.6583, 0.6650, 0.6762, 0.6860, 0.6959, 0.7390, 0.7393, 0.7434, 0.7478, 0.7520, 0.7538, 0.6547, 0.6915, 0.6786, 0.6835, 0.5197, 0.4741, 0.3452, 0.2744, 0.2608, 0.2466, 0.2712, 0.2612, 0.2451, 0.3051, 0.5596, 0.6326, 0.6500, 0.6611, 0.6651, 0.6765, 0.6883, 0.6957, 0.7359, 0.7390, 0.7421, 0.7479, 0.7531, 0.7545, 0.6856, 0.7315, 0.6813, 0.6730, 0.5233, 0.4741, 0.3556, 0.2658, 0.2606, 0.2282, 0.2452, 0.2712, 0.2467, 0.2942, 0.5476, 0.6301, 0.6499, 0.6584, 0.6634, 0.6740, 0.6847, 0.6902, 0.7352, 0.7373, 0.7390, 0.7442, 0.7498, 0.7487, 0.6888, 0.6816, 0.5730, 0.5626, 0.4264, 0.4007, 0.3287, 0.2774, 0.2623, 0.2269, 0.2336, 0.2665, 0.2461, 0.2838, 0.5372, 0.6277, 0.6464, 0.6549, 0.6605, 0.6724, 0.6817, 0.6895, 0.7316, 0.7349, 0.7389, 0.7421, 0.7476, 0.7462, 0.6299, 0.4677, 0.4292, 0.3285, 0.2759, 0.2672, 0.2623, 0.2633, 0.2583, 0.2464, 0.2389, 0.2469, 0.2247, 0.2713, 0.5230, 0.6247, 0.6436, 0.6509, 0.6574, 0.6671, 0.6772, 0.6861, 0.7270, 0.7292, 0.7323, 0.7325, 0.7382, 0.7395, 0.7100, 0.5499, 0.5136, 0.3179, 0.2753, 0.2687, 0.2621, 0.2529, 0.2534, 0.2435, 0.2406, 0.2324, 0.2265, 0.2668, 0.5103, 0.6199, 0.6399, 0.6486, 0.6535, 0.6635, 0.6723, 0.6821, 0.7212, 0.7211, 0.7213, 0.7202, 0.7231, 0.7259, 0.7127, 0.5695, 0.4247, 0.4161, 0.2961, 0.2736, 0.3025, 0.2957, 0.2875, 0.2693, 0.2559, 0.2605, 0.2558, 0.3036, 0.4984, 0.6180, 0.6386, 0.6475, 0.6509, 0.6592, 0.6688, 0.6787, 0.7169, 0.7166, 0.7123, 0.7112, 0.7143, 0.7143, 0.7056, 0.6594, 0.5677, 0.7969, 0.4345, 0.3612, 0.3748, 0.3587, 0.3476, 0.3343, 0.3512, 0.4603, 0.3556, 0.3902, 0.5127, 0.6193, 0.6368, 0.6442, 0.6492, 0.6558, 0.6639, 0.6743, 0.7117, 0.7109, 0.7093, 0.7088, 0.7105, 0.7095, 0.7031, 0.6825, 0.6155, 0.8268, 0.4614, 0.4530, 0.4819, 0.4759, 0.4558, 0.4300, 0.5490, 0.6232, 0.4038, 0.4333, 0.5178, 0.6226, 0.6425, 0.6558, 0.6581, 0.6619, 0.6670, 0.6748, 0.7049, 0.7065, 0.7065, 0.7039, 0.7049, 0.7046, 0.7020, 0.6967, 0.6670, 0.8268, 0.4647, 0.4893, 0.5200, 0.5262, 0.5206, 0.4976, 0.6180, 0.6538, 0.4219, 0.4706, 0.5273, 0.6278, 0.6451, 0.6618, 0.6687, 0.6734, 0.6766, 0.6784, 0.7007, 0.7023, 0.7012, 0.7007, 0.6996, 0.7016, 0.7025, 0.7031, 0.7037, 0.8206, 0.4587, 0.5038, 0.5326, 0.5471, 0.5489, 0.5322, 0.6499, 0.6596, 0.4332, 0.5053, 0.5696, 0.6308, 0.6436, 0.6616, 0.6722, 0.6797, 0.6826, 0.6799, 0.6945, 0.6945, 0.6943, 0.6987, 0.6984, 0.6967, 0.6999, 0.7035, 0.6947, 0.6700, 0.4320, 0.5112, 0.5489, 0.5716, 0.5811, 0.5715, 0.6755, 0.6702, 0.4452, 0.5845, 0.6207, 0.6325, 0.6410, 0.6573, 0.6714, 0.6790, 0.6826, 0.6830, 0.6876, 0.6911, 0.6936, 0.6952, 0.6922, 0.6923, 0.6947, 0.7001, 0.6883, 0.5262, 0.4081, 0.5073, 0.5908, 0.6499, 0.6690, 0.6639, 0.7193, 0.6509, 0.4531, 0.6007, 0.6247, 0.6317, 0.6372, 0.6515, 0.6663, 0.6766, 0.6793, 0.6815, 0.6850, 0.6871, 0.6881, 0.6900, 0.6889, 0.6901, 0.6926, 0.6943, 0.6867, 0.5149, 0.4096, 0.4633, 0.5989, 0.6709, 0.6813, 0.6658, 0.6144, 0.5542, 0.4517, 0.5944, 0.6228, 0.6271, 0.6336, 0.6483, 0.6617, 0.6711, 0.6763, 0.6789, 0.6824, 0.6840, 0.6844, 0.6855, 0.6855, 0.6859, 0.6880, 0.6891, 0.6863, 0.5734, 0.3904, 0.3989, 0.5704, 0.6632, 0.6788, 0.6244, 0.6154, 0.4713, 0.4643, 0.5861, 0.6199, 0.6251, 0.6313, 0.6458, 0.6590, 0.6686, 0.6740, 0.6772, 0.6802, 0.6795, 0.6788, 0.6798, 0.6812, 0.6844, 0.6846, 0.6846, 0.6836, 0.6489, 0.3964, 0.3661, 0.3945, 0.5020, 0.5306, 0.5224, 0.5858, 0.4169, 0.4704, 0.5845, 0.6171, 0.6246, 0.6338, 0.6488, 0.6575, 0.6650, 0.6720, 0.6766, 0.6758, 0.6771, 0.6763, 0.6764, 0.6777, 0.6801, 0.6823, 0.6842, 0.6826, 0.6756, 0.5853, 0.3980, 0.3408, 0.3828, 0.4131, 0.3881, 0.3896, 0.4538, 0.4848, 0.5970, 0.6186, 0.6267, 0.6402, 0.6509, 0.6589, 0.6659, 0.6695, 0.6750, 0.6694, 0.6698, 0.6705, 0.6722, 0.6748, 0.6767, 0.6773, 0.6793, 0.6770, 0.6739, 0.6470, 0.5388, 0.4500, 0.3914, 0.4023, 0.4534, 0.4932, 0.4889, 0.5431, 0.6170, 0.6272, 0.6356, 0.6475, 0.6544, 0.6628, 0.6690, 0.6743, 0.6772, 0.6652, 0.6663, 0.6659, 0.6679, 0.6711, 0.6733, 0.6748, 0.6749, 0.6764, 0.6737, 0.6633, 0.5914, 0.5388, 0.5260, 0.5206, 0.5193, 0.5298, 0.5556, 0.6347, 0.6545, 0.6556, 0.6576, 0.6587, 0.6624, 0.6670, 0.6709, 0.6749, 0.6761]

# Print something to the console
print()
print("---Static Features Inference Test---")

# The ImpulseRunner module will attempt to load files relative to its location,
# so we make it load files relative to this program instead
dir_path = os.path.dirname(os.path.realpath(__file__))
model_path = os.path.join(dir_path, model_file)

# Load the model file
runner = ImpulseRunner(model_path)

# Perfrom inference and print results
try:

    # Print model information
    model_info = runner.init()
    print("Model name:", model_info['project']['name'])
    print("Model owner:", model_info['project']['owner'])

    # Perform inference and time how long it takes
    start_time = time.time_ns()
    res = runner.classify(features)
    elapsed_time = time.time_ns() - start_time
    
    # Display predictions
    print("Predictions:")
    predictions = res['result']['classification']
    for p in predictions:
        print("  " + p + ": " + str(predictions[p]))
    
    # Print out how long it took to perform inference
    print("Inference time:", (elapsed_time / 1000000), "ms")
    
    # Print out the timing breakdown
    print("Timing breakdown:", res['timing'])

finally:
    if (runner):
        runner.stop()
    print()